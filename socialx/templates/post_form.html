{% extends 'layout.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="mb-4">{% if post %}Edit Post{% else %}Create New Post{% endif %}</h2>
                    
                    <form method="POST" enctype="multipart/form-data" id="postForm">
                        {% csrf_token %}
                        
                        <!-- Text Caption -->
                        <div class="form-group mb-4">
                            <label for="{{ form.text.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-chat-text me-2"></i>What's on your mind?
                            </label>
                            {{ form.text }}
                            {% if form.text.errors %}
                                <div class="text-danger mt-2">{{ form.text.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Existing Media Display (Edit Mode) -->
                        {% if post %}
                            {% if post.image or post.video %}
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-image me-2"></i>Current Media:
                                </label>
                                <div class="border rounded p-3" style="background-color: #f8f9fa;">
                                    {% if post.image %}
                                        <img src="{{ post.image.url }}" class="img-fluid rounded mb-2" style="max-height: 300px;">
                                        <p class="text-muted small mb-0"><i class="bi bi-file-image me-1"></i>Current Image</p>
                                    {% elif post.video %}
                                        <video controls class="w-100 rounded mb-2" style="max-height: 300px; background-color: #000;">
                                            <source src="{{ post.video.url }}" type="video/mp4">
                                        </video>
                                        <p class="text-muted small mb-0"><i class="bi bi-file-play me-1"></i>Current Video</p>
                                    {% endif %}
                                </div>
                                <small class="text-muted">Upload a new file below to replace this media</small>
                            </div>
                            {% endif %}
                        {% endif %}

                        <!-- Media Upload -->
                        <div class="form-group mb-4">
                            <label for="mediaUpload" class="form-label fw-bold">
                                <i class="bi bi-image me-2"></i>{% if post %}Replace Media{% else %}Add Photo or Video{% endif %}
                            </label>
                            <input type="file" 
                                   class="form-control" 
                                   id="mediaUpload" 
                                   name="media" 
                                   accept="image/*,video/*"
                                   onchange="previewMedia(event)">
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Max 100MB. Videos over 50MB will be noted for compression.
                            </small>
                        </div>

                        <!-- File Size Warning -->
                        <div class="alert alert-warning d-none" id="sizeWarning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Large file detected!</strong> Your video is over 50MB. 
                            Consider compressing it for faster uploads. 
                            <a href="https://www.freeconvert.com/video-compressor" target="_blank">Compress here</a>
                        </div>

                        <!-- New Media Preview -->
                        <div class="mb-4" id="previewContainer" style="display: none;">
                            <label class="form-label fw-bold">
                                <i class="bi bi-eye me-2"></i>New Media Preview:
                            </label>
                            <div class="border rounded p-3 position-relative" style="background-color: #f8f9fa;">
                                <img id="imagePreview" class="img-fluid rounded d-none" style="max-height: 500px; width: 100%; object-fit: contain;">
                                <video id="videoPreview" class="w-100 rounded d-none" controls style="max-height: 500px; background-color: #000;"></video>
                                
                                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2" onclick="clearMedia()">
                                    <i class="bi bi-x-lg"></i> Remove
                                </button>
                                
                                <div id="fileInfo" class="mt-3 text-muted small"></div>
                            </div>
                        </div>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-circle me-2"></i>{{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% if post %}{% url 'post_detail' post.pk %}{% else %}{% url 'post_list' %}{% endif %}" class="btn btn-outline-secondary btn-modern">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-modern" id="submitBtn">
                                <i class="bi bi-send-fill me-1"></i>
                                {% if post %}Update Post{% else %}Post{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #id_text {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: inherit;
        min-height: 120px;
        resize: vertical;
        transition: border-color 0.2s;
    }

    #id_text:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    body.dark-mode #id_text {
        background-color: #1a1a1a;
        color: #e8e8e8;
        border-color: #2a2a2a;
    }

    body.dark-mode #id_text:focus {
        border-color: #0d6efd;
    }

    body.dark-mode #previewContainer .border,
    body.dark-mode .border {
        background-color: #1a1a1a !important;
        border-color: #2a2a2a !important;
    }
</style>

<script>
let uploadedFile = null;

function previewMedia(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    uploadedFile = file;
    const reader = new FileReader();
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const videoPreview = document.getElementById('videoPreview');
    const fileInfo = document.getElementById('fileInfo');
    const sizeWarning = document.getElementById('sizeWarning');
    
    // File size check
    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
    const maxSize = 100; // MB
    
    if (file.size > maxSize * 1024 * 1024) {
        alert(`File is too large! Maximum size is ${maxSize}MB. Your file is ${sizeMB}MB.`);
        clearMedia();
        return;
    }
    
    // Show warning for files > 50MB
    if (file.size > 50 * 1024 * 1024) {
        sizeWarning.classList.remove('d-none');
    } else {
        sizeWarning.classList.add('d-none');
    }
    
    reader.onload = function(e) {
        previewContainer.style.display = 'block';
        
        if (file.type.startsWith('image/')) {
            // Show image preview
            imagePreview.src = e.target.result;
            imagePreview.classList.remove('d-none');
            videoPreview.classList.add('d-none');
            fileInfo.innerHTML = `<i class="bi bi-file-image me-1"></i> ${file.name} (${sizeMB} MB)`;
        } else if (file.type.startsWith('video/')) {
            // Show video preview
            videoPreview.src = e.target.result;
            videoPreview.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            fileInfo.innerHTML = `<i class="bi bi-file-play me-1"></i> ${file.name} (${sizeMB} MB)`;
        }
    }
    
    reader.readAsDataURL(file);
}

function clearMedia() {
    document.getElementById('mediaUpload').value = '';
    document.getElementById('previewContainer').style.display = 'none';
    document.getElementById('imagePreview').classList.add('d-none');
    document.getElementById('videoPreview').classList.add('d-none');
    document.getElementById('sizeWarning').classList.add('d-none');
    uploadedFile = null;
}

// Form submission
document.getElementById('postForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Posting...';
});
</script>
{% endblock %}